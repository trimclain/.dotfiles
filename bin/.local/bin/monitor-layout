#!/usr/bin/env bash

ensure_installed() {
    if ! command -v "$1" > /dev/null; then
        echo "Error: $1 not found"
        exit 1
    fi
}

# TODO: this is not always the case
#INTERNAL_WIDTH="1366"
#INTERNAL_HEIGHT="768"
#INTERNAL_RESOLUTION="${INTERNAL_WIDTH}x${INTERNAL_HEIGHT}"
EXTERNAL_WIDTH="1920"
EXTERNAL_HEIGHT="1080"
EXTERNAL_RESOLUTION="${EXTERNAL_WIDTH}x${EXTERNAL_HEIGHT}"

if [[ -n $WAYLAND_DISPLAY ]]; then
    ###########################################################################
    # WAYLAND
    ###########################################################################
    if [[ "$DESKTOP_SESSION" == "hyprland" ]]; then
        connectedOutputs=$(hyprctl monitors all | awk '$1 == "Monitor"{print $2}')

        setup_first() {
            if [[ "$DRY_RUN" == "true" ]]; then
                echo "Running 'hyprctl keyword monitor $1,preferred,auto,auto > /dev/null'"
                echo "Running 'hyprctl keyword monitor $2,disable > /dev/null'"
                # echo "Running 'hyprctl dispatch workspace 1 > /dev/null'"
            else
                # Args: name,resolution,position,scale
                hyprctl keyword monitor "$1",preferred,auto,auto > /dev/null
                hyprctl keyword monitor "$2",disable > /dev/null
                # hyprctl dispatch workspace 1 > /dev/null
            fi
        }
        setup_second() {
            if [[ "$DRY_RUN" == "true" ]]; then
                echo "Running 'hyprctl keyword monitor $1,disable > /dev/null'"
                echo "Running 'hyprctl keyword monitor $2,preferred,auto,auto > /dev/null'"
                # echo "Running 'hyprctl keyword monitor $2,$EXTERNAL_RESOLUTION,auto,auto > /dev/null'"
                if [[ "$3" == "--startup" ]]; then
                    echo "Running 'hyprctl dispatch workspace 1 > /dev/null'"
                fi
            else
                hyprctl keyword monitor "$1",disable > /dev/null
                hyprctl keyword monitor "$2",preferred,auto,auto > /dev/null
                # hyprctl keyword monitor "$2","$EXTERNAL_RESOLUTION",auto,auto > /dev/null
                if [[ "$3" == "--startup" ]]; then
                    # we're always on workspace 2 on startup for some reason
                    hyprctl dispatch workspace 1 > /dev/null
                fi
            fi
        }
        setup_extend() {
            if [[ "$DRY_RUN" == "true" ]]; then
                echo "Running 'hyprctl keyword monitor $1,preferred,0x0,auto > /dev/null'"
                echo "Running 'hyprctl keyword monitor $2,preferred,auto-right,auto > /dev/null'"

                echo "Running 'hyprctl keyword workspace 1, monitor:$2, default:true > /dev/null'"
                echo "Running 'hyprctl keyword workspace 2, monitor:$2, default:true > /dev/null'"
                echo "Running 'hyprctl keyword workspace 3, monitor:$2, default:true > /dev/null'"
                echo "Running 'hyprctl keyword workspace 4, monitor:$2, default:true > /dev/null'"
                echo "Running 'hyprctl keyword workspace 5, monitor:$2, default:true > /dev/null'"
                echo "Running 'hyprctl keyword workspace 6, monitor:$2, default:true > /dev/null'"
                echo "Running 'hyprctl keyword workspace 7, monitor:$1, default:true > /dev/null'"
                echo "Running 'hyprctl keyword workspace 8, monitor:$1, default:true > /dev/null'"
                echo "Running 'hyprctl keyword workspace 9, monitor:$1, default:true > /dev/null'"
                # echo "Running 'hyprctl dispatch workspace 1 > /dev/null'"

                echo "Running 'waypaper --backend hyprpaper --restore > /dev/null'"
            else
                # first on the left of second
                hyprctl keyword monitor "$1,preferred,0x0,auto" > /dev/null
                hyprctl keyword monitor "$2,preferred,auto-right,auto" > /dev/null

                # FIX: workspace 1 is for some reason on $1 but can be seen on both bars
                # NOTE: this gets fixed after I empty workspace 1...
                hyprctl keyword workspace "1, monitor:$2, default:true" > /dev/null
                hyprctl keyword workspace "2, monitor:$2, default:true" > /dev/null
                hyprctl keyword workspace "3, monitor:$2, default:true" > /dev/null
                hyprctl keyword workspace "4, monitor:$2, default:true" > /dev/null
                hyprctl keyword workspace "5, monitor:$2, default:true" > /dev/null
                hyprctl keyword workspace "6, monitor:$2, default:true" > /dev/null
                hyprctl keyword workspace "7, monitor:$1, default:true" > /dev/null
                hyprctl keyword workspace "8, monitor:$1, default:true" > /dev/null
                hyprctl keyword workspace "9, monitor:$1, default:true" > /dev/null
                # hyprctl dispatch workspace 1 > /dev/null

                waypaper --backend hyprpaper --restore > /dev/null
            fi
        }
        setup_duplicate() {
            # TODO: implement
            # hyprctl keyword monitor "$intern",preferred,auto,auto > /dev/null
            # hyprctl keyword monitor "$extern",preferred,auto,auto > /dev/null
            return
        }
    else
        echo "Error: $DESKTOP_SESSION not supported"
        exit 1
    fi
else
    ###########################################################################
    # XORG
    ###########################################################################
    ensure_installed xrandr

    # Get info from xrandr
    connectedOutputs=$(xrandr | awk '$2 == "connected"{print $1}')
    # Get the number of enabled monitors:
    # number=$(xrandr --listmonitors | grep Monitors | awk '{print $NF}')

    # TODO: add --mode, --rate, --scale
    # xrandr --output DVI-D-0 --mode 2560x1440 --rate 59.95 --scale 1.5

    setup_first() {
        if [[ "$DRY_RUN" == "true" ]]; then
            echo "Running 'xrandr --output $1 --auto --output $2 --off'"
        else
            xrandr --output "$1" --auto --output "$2" --off
        fi
    }
    setup_second() {
        if [[ "$DRY_RUN" == "true" ]]; then
            echo "Running 'xrandr --output $2 --mode $EXTERNAL_RESOLUTION --primary --output $1 --off'"
        else
            xrandr --output "$2" --mode "$EXTERNAL_RESOLUTION" --primary --output "$1" --off
        fi
    }
    setup_extend() {
        if [[ "$DRY_RUN" == "true" ]]; then
            echo "Running 'xrandr --output $2 --mode $EXTERNAL_RESOLUTION --right-of $1 --output $1 --auto'"
        else
            xrandr --output "$2" --mode "$EXTERNAL_RESOLUTION" --right-of "$1" --output "$1" --auto
        fi
    }
    setup_duplicate() {
        if [[ "$DRY_RUN" == "true" ]]; then
            echo "Running 'xrandr --output $2 --same-as $1 --auto'"
        else
            xrandr --output "$2" --same-as "$1" --auto
        fi
    }
fi

monitors=()
for display in $connectedOutputs; do
    monitors+=("$display")
done

# External monitor is not always the first one
if [[ ${monitors[0]} == *HDMI* ]]; then
    INTERNAL=${monitors[1]}
    EXTERNAL=${monitors[0]}
else
    INTERNAL=${monitors[0]}
    EXTERNAL=${monitors[1]}
fi

if [[ -z $EXTERNAL ]]; then
    exit
fi

MODE="$1"
DRY_RUN='false'
if [[ "$2" == "-d" ]]; then
    DRY_RUN='true'
fi

if [[ "$DRY_RUN" == "true" ]]; then
    echo "Internal: $INTERNAL, External: $EXTERNAL"
fi

if [ "$MODE" = "--first" ]; then
    # Enable first monitor, turn off second one
    setup_first "$INTERNAL" "$EXTERNAL"
elif [ "$MODE" = "--second" ]; then
    # Enable second monitor and make it primary, disable first monitor
    setup_second "$INTERNAL" "$EXTERNAL"
    # TODO: XORG: when first and second monitor have different resolutions,
    # don't use auto, use their resolution instead; problem found in awesomewm
elif [ "$MODE" = "--extend" ]; then
    # Enable dual monitor setup, primary is the monitor, which was primary before
    setup_extend "$INTERNAL" "$EXTERNAL"
    # TODO: XORG: when duplicating monitors with different resolutions,
    # using auto also doesn't work.
elif [ "$MODE" = "--duplicate" ]; then
    # Enable duplicate monitor setup
    setup_duplicate "$INTERNAL" "$EXTERNAL"
elif [ "$MODE" = "--startup" ]; then
    # If there's a connected hmdi output, make --second
    setup_second "$INTERNAL" "$EXTERNAL" "--startup"
fi
