#!/usr/bin/env bash

BACKUP_FOLDER="$HOME/.dotfiles/.backup"

# Functions
existing_files_check(){
    arr=("$@")
    for file in "${arr[@]}"; do
        # Check if file exists and is not a symlink
        if [[ -f $file && ! -h $file ]]; then
            # Create a backup folder
            mkdir -p ~/.dotfiles/.backup
            echo Found existing $file
            echo Moving $file to ~/.dotfiles/.backup
            mv $file $BACKUP_FOLDER
        # check for folders aswell
        elif [[ -d $file && ! -h $file ]]; then
            # Create a backup folder
            mkdir -p ~/.dotfiles/.backup
            echo Found existing $file
            echo Moving $file to ~/.dotfiles/.backup
            mv $file $BACKUP_FOLDER
        fi
    done
}


# Get the mode, default to normal
if [[ -n $1 ]]; then
    # Full installation
    if [[ $1 == "-f" || $1 == "--full" ]]; then

        # Folders to stow
        STOW_FOLDERS="bin,bash,nvim,tmux,vim,zsh"

        # Check if there are any old files that are not symlinks and move them to backup, so stow works
        DOTFS=(~/.bashrc ~/.zshrc ~/.tmux.conf ~/.vimrc ~/.config/nvim)
        existing_files_check "${DOTFS[@]}"

    # Small installation
    elif [[ $1 == "-s" || $1 == "--small" ]]; then

        # Folders to stow
        STOW_FOLDERS="bin,bash,tmux,vim"

        # Check if there are any old files that are not symlinks and move them
        DOTFS=(~/.bashrc ~/.tmux.conf ~/.vimrc)
        existing_files_check "${DOTFS[@]}"
    # Linux installation
    elif [[ $1 == "-l" || $1 == "--linux" ]]; then

        # Folders to stow (picom not added yet)
        STOW_FOLDERS="bin,nvim,tmux,zsh,i3,alacritty,rofi"

        # Check if there are any old files that are not symlinks and move them (picom will be added)
        DOTFS=(~/.zshrc ~/.tmux.conf ~/.config/nvim ~/.config/i3 ~/.config/alacritty)
        existing_files_check "${DOTFS[@]}"
    fi

# Normal installation
else

    # Folders to stow
    STOW_FOLDERS="bin,nvim,tmux,zsh"

    # Check if there are any old files that are not symlinks and delete them, so stow works
    DOTFS=(~/.zshrc ~/.tmux.conf ~/.config/nvim)
    existing_files_check "${DOTFS[@]}"

fi


# Stow Time
if [[ -n $DOTFILES ]]; then
    pushd $DOTFILES > /dev/null

    for folder in $(echo $STOW_FOLDERS | sed "s/,/ /g")
    do
        stow -R $folder
        echo "Adding symlink to" $folder
    done
    echo Done

    popd > /dev/null
else

    for folder in $(echo $STOW_FOLDERS | sed "s/,/ /g")
    do
        stow -R $folder
        echo "Adding symlink to" $folder
    done
    echo Done

fi
