#!/usr/bin/env bash

# NOTE: shell_check doesn't work on Mac yet

BACKUP_FOLDER="$HOME/.dotfiles/.backup"

# Functions
shell_check(){
    # Check if zsh is the shell, change if not
    if [[ ! $SHELL == "/usr/bin/zsh" ]]; then
        echo Changing your shell to ZSH. Enter the password.
        chsh -s $(which zsh)
        echo Successfully switched to ZSH. Don\'t forget to Restart your terminal.
    fi
}

existing_files_check(){
    arr=("$@")
    for file in "${arr[@]}"; do
        # Check if file exists and is not a symlink
        if [[ -f $file && ! -h $file ]]; then
            # Create a backup folder
            mkdir -p ~/.dotfiles/.backup
            echo Found existing $file
            echo Moving $file to ~/.dotfiles/.backup
            mv $file $BACKUP_FOLDER
        fi
    done
}

install_fonts(){
    # Copy fonts
    cp ~/.dotfiles/fonts/* ~/.local/share/fonts/
}

# Get the mode, default to normal
if [[ -n $1 ]]; then
    # Full installation
    if [[ $1 == "-f" || $1 == "--full" ]]; then

        # Create .vim/undodir for vim and .nvim/undodir for nvim
        mkdir -p ~/.nvim/undodir
        mkdir -p ~/.vim/undodir

        # Folders to stow
        STOW_FOLDERS="bin,bash,i3,nvim,tmux,vim,zsh"

        shell_check

        # Check if there are any old files that are not symlinks and delete them, so stow works
        DOTFS=(~/.bashrc ~/.zshrc ~/.tmux.conf ~/.vimrc ~/.config/i3 ~/.config/i3status)
        existing_files_check "${DOTFS[@]}"

    # Small installation
    elif [[ $1 == "-s" || $1 == "--small" ]]; then

        # Create .vim/undodir for vim
        mkdir -p ~/.vim/undodir

        # Folders to stow
        STOW_FOLDERS="bin,bash,tmux,vim"

        # Check if there are any old files that are not symlinks and delete them, so stow works
        DOTFS=(~/.bashrc ~/.tmux.conf ~/.vimrc)
        existing_files_check "${DOTFS[@]}"
    fi

# Normal installation
else

    # Create .nvim/undodir for nvim
    mkdir -p ~/.nvim/undodir

    # Folders to stow
    STOW_FOLDERS="bin,i3,nvim,tmux,zsh"

    shell_check

    # Check if there are any old files that are not symlinks and delete them, so stow works
    DOTFS=(~/.zshrc ~/.tmux.conf ~/.config/i3 ~/.config/i3status)
    existing_files_check "${DOTFS[@]}"

fi


# Stow Time
if [[ -n $DOTFILES ]]; then
    pushd $DOTFILES > /dev/null

    for folder in $(echo $STOW_FOLDERS | sed "s/,/ /g")
    do
        stow -D $folder
        stow $folder
        echo "Adding symlink to" $folder
    done
    echo Done

    popd > /dev/null
else

    for folder in $(echo $STOW_FOLDERS | sed "s/,/ /g")
    do
        stow -D $folder
        stow $folder
        echo "Adding symlink to" $folder
    done
    echo Done

fi

